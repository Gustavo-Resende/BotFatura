---
description: Regras de arquitetura, padr√µes de c√≥digo e vis√£o de neg√≥cio para o projeto BotFatura
globs: **/*.cs, **/*.json
---

# BotFatura - Diretrizes Oficiais

## üéØ Objetivo e Fluxo
Sistema de baixa autom√°tica de faturas via WhatsApp.
1. Recebe comprovante (PDF/Imagem) -> Evolution API.
2. Gemini extrai dados -> Valida pagador, valor (toler√¢ncia R$0,01) e destino.
3. [Sucesso]: Baixa fatura, avisa cliente e s√≥cios.
4. [Falha]: Notifica erro ao cliente.

## üèóÔ∏è Arquitetura e Tech Stack
- **Padr√£o:** Clean Architecture + CQRS + DDD.
- **Camadas:**
  - **Domain:** Entidades ricas, Logic Core, GuardClauses, sem setters p√∫blicos.
  - **Application:** Casos de uso (MediatR), Commands/Queries separados, FluentValidation.
  - **Infrastructure:** EF Core (EntityTypeConfiguration), integra√ß√µes externas.
  - **Presentation:** Minimal APIs apenas.
- **Async:** Obrigat√≥rio `Async` no sufixo e `CancellationToken` em toda a cadeia.

## üáßüá∑ Regras de Nomenclatura (OBRIGAT√ìRIO)
- **Idioma:** TODO o c√≥digo (vari√°veis, classes, m√©todos, propriedades) deve ser em **Portugu√™s Brasileiro**.
- **Exce√ß√µes:** Termos t√©cnicos (Id, JID, Async, HTTP, JSON).
- **Proibido:** Abrevia√ß√µes (vlr, cli) ou termos em ingl√™s (Customer, Invoice).
- **Correto:** `clienteId`, `valorFatura`, `processarPagamentoAsync`.

## üõ†Ô∏è Padr√µes de Implementa√ß√£o
- **Result Pattern:** Use `Result<T>` para retornos de servi√ßo; nunca lance exce√ß√µes para fluxo de neg√≥cio.
- **Logs:** Use `ILogger<T>` com logs estruturados (entrada/sa√≠da de APIs externas).
- **Testes:** Unit√°rios (xUnit + FluentAssertions + NSubstitute). Nome: `Metodo_Cenario_Resultado`.
- **Inje√ß√£o de Depend√™ncia:** Sempre via construtor.
- **Terminal:** Use estritamente **PowerShell**.

## ‚ö†Ô∏è Restri√ß√µes
- N√£o use Data Annotations em entidades (use Fluent API no Infra).
- N√£o use l√≥gica de neg√≥cio em Controllers/Minimal APIs.
- Jamais exponha Stack Trace em respostas (use ProblemDetails).